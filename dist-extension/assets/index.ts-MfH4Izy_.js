console.log("ğŸ›¡ï¸ Web Security Guardian Background Service Starting...");let r={enabled:!0,maliciousUrlProtection:!0,xssProtection:!0,trackerBlocking:!0,formProtection:!0,phishingProtection:!0,notifications:!0,autoUpdate:!0,strictMode:!1};chrome.storage.local.get(["protection_settings"],e=>{e.protection_settings&&(r={...r,...e.protection_settings},console.log("âœ… Protection settings loaded:",r))});chrome.storage.onChanged.addListener((e,s)=>{s==="local"&&e.protection_settings&&(r=e.protection_settings.newValue,console.log("âš™ï¸ Protection settings updated:",r))});class g{maliciousUrls=new Set(["malware-example.com","phishing-test.net","suspicious-site.org","fake-bank.com","scam-lottery.net"]);trackerDomains=new Set(["google-analytics.com","googletagmanager.com","facebook.com","doubleclick.net","googlesyndication.com","amazon-adsystem.com"]);isMalicious(s){try{const t=new URL(s).hostname.toLowerCase();return Array.from(this.maliciousUrls).some(a=>t===a||t.endsWith("."+a))}catch{return!1}}isTracker(s){try{const t=new URL(s).hostname.toLowerCase();return Array.from(this.trackerDomains).some(a=>t===a||t.endsWith("."+a))}catch{return!1}}}const u=new g;chrome.runtime.onInstalled.addListener(e=>{console.log("âœ… Extension installed:",e.reason),e.reason==="install"&&(chrome.storage.local.set({protection_settings:{enabled:!0,maliciousUrlProtection:!0,xssProtection:!0,trackerBlocking:!0,formProtection:!0,phishingProtection:!0,notifications:!0,autoUpdate:!0,strictMode:!1},security_stats:{totalThreats:0,blockedThreats:0,allowedThreats:0,threatsByType:{malicious_url:0,xss_attack:0,tracker:0,insecure_form:0,suspicious_script:0,phishing:0},threatsByLevel:{low:0,medium:0,high:0,critical:0},lastScanTime:0},whitelist:[],blacklist:[]}),chrome.tabs.create({url:chrome.runtime.getURL("src/options/index.html")}))});chrome.webRequest.onBeforeRequest.addListener(e=>{r.enabled&&(r.maliciousUrlProtection&&u.isMalicious(e.url)&&(console.log("ğŸš« Malicious URL detected (blocked by declarativeNetRequest):",e.url),chrome.storage.local.get(["security_stats"],s=>{if(s.security_stats){const t=s.security_stats;t.totalThreats++,t.blockedThreats++,t.threatsByType.malicious_url++,t.threatsByLevel.high++,chrome.storage.local.set({security_stats:t})}}),r.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon.svg"),title:"ğŸš« æ¶æ„URLå·²é˜»æ­¢",message:`å·²æ‹¦æˆªæ¶æ„ç½‘ç«™: ${new URL(e.url).hostname}`,priority:2})),r.trackerBlocking&&u.isTracker(e.url)&&(console.log("ğŸ‘ï¸ Tracker request detected (blocked by declarativeNetRequest):",e.url),chrome.storage.local.get(["security_stats"],s=>{if(s.security_stats){const t=s.security_stats;t.totalThreats++,t.blockedThreats++,t.threatsByType.tracker++,t.threatsByLevel.medium++,chrome.storage.local.set({security_stats:t})}})))},{urls:["<all_urls>"]});chrome.runtime.onMessage.addListener((e,s,t)=>{console.log("ğŸ“¨ Received message:",e.type);try{switch(e.type){case"GET_SECURITY_STATUS":return chrome.storage.local.get(["security_stats"],o=>{t({maliciousUrlsCount:o.security_stats?.blockedThreats||0,trackersBlocked:o.security_stats?.threatsByType?.tracker||0})}),!0;case"GET_STATS":return chrome.storage.local.get(["security_stats"],o=>{t(o.security_stats||{totalThreats:0,blockedThreats:0,allowedThreats:0,threatsByType:{},threatsByLevel:{},lastScanTime:Date.now()})}),!0;case"UPDATE_SETTINGS":return chrome.storage.local.set({protection_settings:e.data},()=>{r=e.data,console.log("âœ… Settings saved and applied:",r),t({success:!0})}),!0;case"GET_SETTINGS":return chrome.storage.local.get(["protection_settings"],o=>{t(o.protection_settings||r)}),!0;case"SETTINGS_UPDATED":console.log("âš™ï¸ Settings updated:",e.data),r=e.data,t({success:!0});break;case"TOGGLE_PROTECTION":console.log("ğŸ”„ Protection toggled:",e.data),t({success:!0});break;case"SCAN_PAGE":console.log("ğŸ” Scanning page:",e.data?.tabId),t({success:!0});break;case"PAGE_NAVIGATION":console.log("ğŸ”„ Page navigation detected, clearing previous threats for:",e.url);let a="";try{a=new URL(e.url).hostname}catch{a=e.url}return chrome.storage.local.get(["threat_history"],o=>{const i=o.threat_history||[],l=i.filter(n=>{try{return new URL(n.url).hostname!==a}catch{return!n.url.includes(a)}});console.log(`ğŸ—‘ï¸ Cleared ${i.length-l.length} threats for ${a}`),chrome.storage.local.set({threat_history:l},()=>{t({success:!0,clearedCount:i.length-l.length})})}),!0;case"THREAT_DETECTED":if(console.log("ğŸš¨ Threat detected:",e.threat||e.data),!r.enabled){console.log("â¸ï¸ Protection disabled, threat not recorded"),t({success:!1,reason:"protection_disabled"});break}const c=e.threat||e.data;if(!(()=>{switch(c.type){case"malicious_url":return r.maliciousUrlProtection;case"xss_attack":return r.xssProtection;case"tracker":return r.trackerBlocking;case"insecure_form":return r.formProtection;case"phishing":return r.phishingProtection;case"suspicious_script":return r.xssProtection;default:return!0}})()){console.log(`â­ï¸ Threat type ${c.type} protection is disabled`),t({success:!1,reason:"feature_disabled"});break}chrome.storage.local.get(["security_stats","threat_history"],o=>{const i=o.security_stats||{totalThreats:0,blockedThreats:0,allowedThreats:0,threatsByType:{malicious_url:0,xss_attack:0,sql_injection:0,tracker:0,insecure_form:0,suspicious_script:0,phishing:0,data_leak:0},threatsByLevel:{low:0,medium:0,high:0,critical:0},lastScanTime:Date.now()};i.totalThreats++,c.blocked?i.blockedThreats++:i.allowedThreats++,i.threatsByType[c.type]!==void 0&&i.threatsByType[c.type]++,i.threatsByLevel[c.level]!==void 0&&i.threatsByLevel[c.level]++,i.lastScanTime=Date.now();const l=o.threat_history||[];if(l.unshift(c),l.length>100&&l.splice(100),chrome.storage.local.set({security_stats:i,threat_history:l}),console.log("ğŸ“Š Stats updated:",i),r.notifications&&c.blocked){const n={malicious_url:"æ¶æ„URL",xss_attack:"XSSæ”»å‡»",tracker:"è¿½è¸ªå™¨",insecure_form:"ä¸å®‰å…¨è¡¨å•",phishing:"é’“é±¼ç½‘ç«™",suspicious_script:"å¯ç–‘è„šæœ¬"};chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon.svg"),title:`ğŸ›¡ï¸ å·²é˜»æ­¢${n[c.type]||"å¨èƒ"}`,message:c.description||`æ£€æµ‹åˆ°${n[c.type]}`,priority:c.level==="critical"||c.level==="high"?2:1})}}),t({success:!0});break;case"SECURITY_ISSUE":console.log("âš ï¸ Security issue:",e.issueType,e.data),t({success:!0});break;case"UPDATE_WHITELIST":return console.log("ğŸ“ Updating whitelist:",e.data),chrome.storage.local.set({whitelist:e.data},()=>{console.log("âœ… Whitelist updated successfully"),t({success:!0})}),!0;case"GET_WHITELIST":return chrome.storage.local.get(["whitelist"],o=>{console.log("ğŸ“‹ Getting whitelist:",o.whitelist),t({whitelist:o.whitelist||[]})}),!0;case"UPDATE_BLACKLIST":return console.log("ğŸ“ Updating blacklist:",e.data),chrome.storage.local.set({blacklist:e.data},()=>{console.log("âœ… Blacklist updated successfully"),t({success:!0})}),!0;case"GET_BLACKLIST":return chrome.storage.local.get(["blacklist"],o=>{console.log("ğŸ“‹ Getting blacklist:",o.blacklist),t({blacklist:o.blacklist||[]})}),!0;default:t({success:!0})}}catch(a){console.error("âŒ Error handling message:",a),t({error:String(a)})}return!0});chrome.tabs.onUpdated.addListener((e,s,t)=>{s.status==="complete"&&t.url&&(console.log("ğŸ“„ Page loaded:",t.url),r.enabled&&r.maliciousUrlProtection&&u.isMalicious(t.url)&&(console.log("âš ï¸ Warning: Potentially malicious page"),r.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon.svg"),title:"âš ï¸ è­¦å‘Šï¼šå¯ç–‘ç½‘ç«™",message:`æ‚¨æ­£åœ¨è®¿é—®å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©çš„ç½‘ç«™: ${new URL(t.url).hostname}`,priority:2})))});chrome.webRequest.onHeadersReceived.addListener(e=>{console.log("ğŸ” Headers received from:",e.url)},{urls:["<all_urls>"]});console.log("âœ… Web Security Guardian Background Service Started Successfully");let h=0;setInterval(()=>{h++,console.log(`ğŸ’“ Service Worker heartbeat #${h}`)},3e4);
